generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// DEVICE TOKENS - APNs Push Notifications
// ============================================
model DeviceToken {
  id        String   @id @default(uuid())
  token     String   @unique
  platform  String   // ios, macos, ipados
  bundleId  String?  @default("com.tomos.app")
  name      String?  // Device name (e.g., "Tom's iPhone")
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("device_tokens")
  @@index([active])
  @@index([platform])
}

// ============================================
// PROJECTS
// ============================================
model Project {
  id          String   @id @default(uuid())
  title       String
  description String?
  color       String?  // Hex color
  icon        String?  // Emoji or icon name
  status      String   @default("active") // active, archived, completed
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tasks Task[]
  notes Note[]

  @@map("projects")
}

// ============================================
// TASKS
// ============================================
model Task {
  id          String    @id @default(uuid())
  title       String
  description String?
  status      String    @default("todo") // todo, in_progress, done, blocked
  priority    String    @default("medium") // low, medium, high, urgent
  dueDate     DateTime?
  completedAt DateTime?
  projectId   String?
  matterId    String?   // Link to MatterOS matter
  parentId    String?   // Subtask parent (one level deep)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  project     Project?      @relation(fields: [projectId], references: [id], onDelete: SetNull)
  matter      Matter?       @relation(fields: [matterId], references: [id], onDelete: SetNull)
  parent      Task?         @relation("Subtasks", fields: [parentId], references: [id], onDelete: SetNull)
  children    Task[]        @relation("Subtasks")
  tags        TaskTag[]
  notes       Note[]
  gymSessions GymSession[]

  @@map("tasks")
  @@index([status])
  @@index([priority])
  @@index([projectId])
  @@index([matterId])
  @@index([dueDate])
  @@index([parentId])
}

// ============================================
// TAGS
// ============================================
model Tag {
  id        String   @id @default(uuid())
  name      String   @unique
  color     String?  // Hex color
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tasks TaskTag[]

  @@map("tags")
}

// ============================================
// TASK-TAG JUNCTION (Many-to-Many)
// ============================================
model TaskTag {
  taskId String
  tagId  String

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([taskId, tagId])
  @@map("task_tags")
}

// ============================================
// MATTEROS - Legal Matter Management
// ============================================

// MATTERS
model Matter {
  id             String   @id @default(uuid())

  // Basic Info
  title          String
  description    String?  @db.Text
  client         String   // Client name (later: relation to Client table)
  matterNumber   String?  @unique // e.g., "PUB-2026-001"
  type           String   // contract, dispute, compliance, advisory, employment, ip, regulatory
  status         String   @default("active") // active, on_hold, completed, archived
  priority       String   @default("medium") // low, medium, high, urgent

  // Dates
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  dueDate        DateTime?
  completedAt    DateTime?
  lastActivityAt DateTime @default(now())

  // Financial
  budget         Decimal? @db.Decimal(12, 2)
  actualSpend    Decimal? @db.Decimal(12, 2)
  billingStatus  String?  // billable, non_billable, fixed_fee, time_and_materials

  // People
  clientContact   String?
  leadCounsel     String?  // Internal lead lawyer
  teamMembers     String[] // Array of team member names
  externalCounsel String[] // External law firms

  // Organization
  practiceArea   String?  // Commercial, IP, Employment, Regulatory, etc.
  jurisdiction   String?  // NSW, VIC, Commonwealth, International
  tags           String[]

  // Relations
  tasks          Task[]
  documents      MatterDocument[]
  events         MatterEvent[]
  matterNotes    MatterNote[]      @relation("MatterNotes")
  notes          Note[]

  @@map("matters")
  @@index([status])
  @@index([priority])
  @@index([client])
  @@index([type])
  @@index([dueDate])
  @@index([lastActivityAt])
}

// MATTER DOCUMENTS
model MatterDocument {
  id          String   @id @default(uuid())
  matterId    String

  title       String
  type        String   // contract, email, memo, correspondence, court_filing, research
  description String?  @db.Text

  // Storage
  fileUrl     String?  // SharePoint, Google Drive, etc.
  localPath   String?  // Local file path

  // Metadata
  version     String?  // v1.0, v2.0, etc.
  status      String?  // draft, final, executed, superseded
  author      String?
  reviewedBy  String?

  // Dates
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  signedAt    DateTime?
  expiresAt   DateTime?

  // Relations
  matter      Matter   @relation(fields: [matterId], references: [id], onDelete: Cascade)

  @@map("matter_documents")
  @@index([matterId])
  @@index([type])
  @@index([status])
}

// MATTER EVENTS (Timeline/Activity Log)
model MatterEvent {
  id          String   @id @default(uuid())
  matterId    String

  type        String   // status_change, document_added, task_completed, note_added, meeting, deadline
  title       String
  description String?  @db.Text

  // Metadata
  actor       String?  // Who performed the action
  metadata    Json?    // Additional structured data

  createdAt   DateTime @default(now())

  // Relations
  matter      Matter   @relation(fields: [matterId], references: [id], onDelete: Cascade)

  @@map("matter_events")
  @@index([matterId])
  @@index([type])
  @@index([createdAt])
}

// MATTER NOTES
model MatterNote {
  id        String   @id @default(uuid())
  matterId  String

  title     String?
  content   String   @db.Text // Markdown or rich text
  type      String   @default("general") // general, decision, analysis, research, meeting_notes

  // Metadata
  author    String?
  tags      String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  matter    Matter   @relation("MatterNotes", fields: [matterId], references: [id], onDelete: Cascade)

  @@map("matter_notes")
  @@index([matterId])
  @@index([type])
}

// ============================================
// GENERAL NOTES - Standalone note-taking
// ============================================
model Note {
  id        String   @id @default(uuid())

  // Content
  title     String
  content   String   @db.Text // Markdown supported
  excerpt   String?  // Auto-generated from first 200 chars

  // Organization
  tags         String[] // Can reuse existing tag system
  isPinned     Boolean  @default(false)

  // Enhanced Properties
  priority     String?  @default("medium") // low, medium, high, urgent
  status       String?  @default("active") // draft, active, archived
  reviewDate   DateTime? // For notes that need periodic review
  confidential Boolean  @default(false) // Flag for sensitive legal content

  // Smart Linking (parsed mentions stored as JSON)
  links        Json?    // {tasks: [], matters: [], projects: [], notes: []}

  // Optional Relations (link notes to tasks or matters)
  taskId    String?
  matterId  String?
  projectId String?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  task      Task?    @relation(fields: [taskId], references: [id], onDelete: SetNull)
  matter    Matter?  @relation(fields: [matterId], references: [id], onDelete: SetNull)
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@map("notes")
  @@index([isPinned])
  @@index([createdAt])
  @@index([taskId])
  @@index([matterId])
  @@index([projectId])
  @@index([priority])
  @@index([status])
  @@index([reviewDate])
  @@index([confidential])
}

// ============================================
// FITNESSOS - Gym & Fitness Tracking
// ============================================

model GymSession {
  id              String    @id @default(uuid())
  date            DateTime  @default(now())
  sessionType     String    // "A", "B", "C", or custom
  duration        Int?      // minutes
  notes           String?
  overallRPE      Int?      // 1-10
  weekType        String?   // "kid" or "non-kid"
  completedAt     DateTime?

  // Relations
  taskId          String?
  task            Task?     @relation(fields: [taskId], references: [id], onDelete: SetNull)
  sessionExercises SessionExercise[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("gym_sessions")
  @@index([date])
  @@index([sessionType])
}

model Exercise {
  id              String   @id @default(uuid())
  name            String   @unique
  category        String   // "power", "strength", "accessory", "core", "warmup", "conditioning"
  equipment       String[] // ["barbell", "dumbbell", "kettlebell", "bodyweight"]
  primaryMuscles  String[] // ["glutes", "hamstrings", "quads"]
  movementPattern String?  // "hip_hinge", "squat", "push", "pull", "carry", "rotation"
  cues            String?  // Coaching cues
  spineNotes      String?  // L4/5, S1 considerations
  videoUrl        String?

  sessionExercises SessionExercise[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("exercises")
  @@index([category])
  @@index([movementPattern])
}

model SessionExercise {
  id              String   @id @default(uuid())
  order           Int      // Order within session

  // Relations
  sessionId       String
  session         GymSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  exerciseId      String
  exercise        Exercise @relation(fields: [exerciseId], references: [id])

  sets            ExerciseSet[]

  createdAt       DateTime @default(now())

  @@map("session_exercises")
  @@index([sessionId])
}

model ExerciseSet {
  id                String   @id @default(uuid())
  setNumber         Int
  weight            Float?   // kg
  reps              Int?
  time              Int?     // seconds (for holds/carries)
  distance          Float?   // meters (for carries)
  rpe               Int?     // 1-10
  notes             String?

  // Relations
  sessionExerciseId String
  sessionExercise   SessionExercise @relation(fields: [sessionExerciseId], references: [id], onDelete: Cascade)

  createdAt         DateTime @default(now())

  @@map("exercise_sets")
  @@index([sessionExerciseId])
}

model RunningSync {
  id              String   @id @default(uuid())
  externalId      String   @unique // Strava activity ID
  source          String   @default("strava") // "strava", "garmin", "manual"
  date            DateTime
  type            String   // "easy", "intervals", "tempo", "hills", "long"
  distance        Float    // km
  duration        Int      // minutes
  avgPace         Float?   // min/km
  avgHeartRate    Int?
  elevationGain   Float?   // meters
  trainingLoad    Float?   // Calculated load score

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("running_sync")
  @@index([date])
  @@index([source])
}

model RecoveryCheckIn {
  id              String   @id @default(uuid())
  date            DateTime @default(now())
  sleepQuality    Int      // 1-5
  soreness        Int      // 1-5 (1=very sore, 5=fresh)
  energy          Int      // 1-5
  motivation      Int      // 1-5
  hoursSlept      Float?
  notes           String?
  readinessScore  Float?   // Computed average
  createdAt       DateTime @default(now())

  @@map("recovery_checkins")
  @@index([date])
}

model NutritionLog {
  id              String   @id @default(uuid())
  date            DateTime @default(now())
  proteinRating   Int?     // 1-3 (low/okay/good)
  hydrationRating Int?     // 1-3
  vegetableRating Int?     // 1-3
  notes           String?
  createdAt       DateTime @default(now())

  @@map("nutrition_logs")
  @@index([date])
}

model StravaToken {
  id            String   @id @default("singleton")
  accessToken   String
  refreshToken  String
  expiresAt     Int      // Unix timestamp
  athleteId     Int?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("strava_tokens")
}

// ============================================
// JOURNAL - Reflective journaling with AI companion
// ============================================

model JournalEntry {
  id          String    @id @default(uuid())

  // Content
  content     String    @db.Text
  title       String?   // Optional - auto-generated from first line if blank
  excerpt     String?   // Auto-generated from first 200 chars
  wordCount   Int       @default(0)

  // Mood & Energy
  mood        String?   // great, good, okay, low, rough
  energy      String?   // high, medium, low

  // AI Analysis
  reflection  String?   @db.Text // AI-generated reflection on entry
  themes      String[]  // Extracted themes (e.g., "work", "kids", "exercise")
  tags        String[]  // User-applied tags

  // Timestamps
  entryDate   DateTime  @default(now()) // The date the entry is "about"
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  conversations JournalConversation[]

  @@map("journal_entries")
  @@index([entryDate])
  @@index([mood])
  @@index([createdAt])
}

model JournalConversation {
  id          String    @id @default(uuid())
  entryId     String?   // Optional - can be standalone chat

  // Metadata
  title       String?   // Auto-generated summary
  mode        String    @default("chat") // journal, chat, hybrid

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  entry       JournalEntry? @relation(fields: [entryId], references: [id], onDelete: SetNull)
  messages    JournalMessage[]

  @@map("journal_conversations")
  @@index([entryId])
  @@index([createdAt])
}

model JournalMessage {
  id              String   @id @default(uuid())
  conversationId  String

  role            String   // user, assistant
  content         String   @db.Text

  createdAt       DateTime @default(now())

  // Relations
  conversation    JournalConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@map("journal_messages")
  @@index([conversationId])
  @@index([createdAt])
}

model JournalSummary {
  id          String   @id @default(uuid())
  type        String   // weekly, monthly
  periodStart DateTime
  periodEnd   DateTime

  // AI-generated content
  content     String   @db.Text // The reflection/summary text
  themes      String[] // Extracted themes for the period
  moodPattern String?  // Description of mood trends
  insights    Json?    // Structured pattern data

  createdAt   DateTime @default(now())

  @@map("journal_summaries")
  @@index([type])
  @@index([periodStart])
}

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// PROJECTS
// ============================================
model Project {
  id          String   @id @default(uuid())
  title       String
  description String?
  color       String?  // Hex color
  icon        String?  // Emoji or icon name
  status      String   @default("active") // active, archived, completed
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tasks Task[]
  notes Note[]

  @@map("projects")
}

// ============================================
// TASKS
// ============================================
model Task {
  id          String    @id @default(uuid())
  title       String
  description String?
  status      String    @default("todo") // todo, in_progress, done, blocked
  priority    String    @default("medium") // low, medium, high, urgent
  dueDate     DateTime?
  completedAt DateTime?
  projectId   String?
  matterId    String?   // Link to MatterOS matter
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  project Project?  @relation(fields: [projectId], references: [id], onDelete: SetNull)
  matter  Matter?   @relation(fields: [matterId], references: [id], onDelete: SetNull)
  tags    TaskTag[]
  notes   Note[]

  @@map("tasks")
  @@index([status])
  @@index([priority])
  @@index([projectId])
  @@index([matterId])
  @@index([dueDate])
}

// ============================================
// TAGS
// ============================================
model Tag {
  id        String   @id @default(uuid())
  name      String   @unique
  color     String?  // Hex color
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tasks TaskTag[]

  @@map("tags")
}

// ============================================
// TASK-TAG JUNCTION (Many-to-Many)
// ============================================
model TaskTag {
  taskId String
  tagId  String

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([taskId, tagId])
  @@map("task_tags")
}

// ============================================
// MATTEROS - Legal Matter Management
// ============================================

// MATTERS
model Matter {
  id             String   @id @default(uuid())

  // Basic Info
  title          String
  description    String?  @db.Text
  client         String   // Client name (later: relation to Client table)
  matterNumber   String?  @unique // e.g., "PUB-2026-001"
  type           String   // contract, dispute, compliance, advisory, employment, ip, regulatory
  status         String   @default("active") // active, on_hold, completed, archived
  priority       String   @default("medium") // low, medium, high, urgent

  // Dates
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  dueDate        DateTime?
  completedAt    DateTime?
  lastActivityAt DateTime @default(now())

  // Financial
  budget         Decimal? @db.Decimal(12, 2)
  actualSpend    Decimal? @db.Decimal(12, 2)
  billingStatus  String?  // billable, non_billable, fixed_fee, time_and_materials

  // People
  clientContact   String?
  leadCounsel     String?  // Internal lead lawyer
  teamMembers     String[] // Array of team member names
  externalCounsel String[] // External law firms

  // Organization
  practiceArea   String?  // Commercial, IP, Employment, Regulatory, etc.
  jurisdiction   String?  // NSW, VIC, Commonwealth, International
  tags           String[]

  // Relations
  tasks          Task[]
  documents      MatterDocument[]
  events         MatterEvent[]
  matterNotes    MatterNote[]      @relation("MatterNotes")
  notes          Note[]

  @@map("matters")
  @@index([status])
  @@index([priority])
  @@index([client])
  @@index([type])
  @@index([dueDate])
  @@index([lastActivityAt])
}

// MATTER DOCUMENTS
model MatterDocument {
  id          String   @id @default(uuid())
  matterId    String

  title       String
  type        String   // contract, email, memo, correspondence, court_filing, research
  description String?  @db.Text

  // Storage
  fileUrl     String?  // SharePoint, Google Drive, etc.
  localPath   String?  // Local file path

  // Metadata
  version     String?  // v1.0, v2.0, etc.
  status      String?  // draft, final, executed, superseded
  author      String?
  reviewedBy  String?

  // Dates
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  signedAt    DateTime?
  expiresAt   DateTime?

  // Relations
  matter      Matter   @relation(fields: [matterId], references: [id], onDelete: Cascade)

  @@map("matter_documents")
  @@index([matterId])
  @@index([type])
  @@index([status])
}

// MATTER EVENTS (Timeline/Activity Log)
model MatterEvent {
  id          String   @id @default(uuid())
  matterId    String

  type        String   // status_change, document_added, task_completed, note_added, meeting, deadline
  title       String
  description String?  @db.Text

  // Metadata
  actor       String?  // Who performed the action
  metadata    Json?    // Additional structured data

  createdAt   DateTime @default(now())

  // Relations
  matter      Matter   @relation(fields: [matterId], references: [id], onDelete: Cascade)

  @@map("matter_events")
  @@index([matterId])
  @@index([type])
  @@index([createdAt])
}

// MATTER NOTES
model MatterNote {
  id        String   @id @default(uuid())
  matterId  String

  title     String?
  content   String   @db.Text // Markdown or rich text
  type      String   @default("general") // general, decision, analysis, research, meeting_notes

  // Metadata
  author    String?
  tags      String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  matter    Matter   @relation("MatterNotes", fields: [matterId], references: [id], onDelete: Cascade)

  @@map("matter_notes")
  @@index([matterId])
  @@index([type])
}

// ============================================
// GENERAL NOTES - Standalone note-taking
// ============================================
model Note {
  id        String   @id @default(uuid())

  // Content
  title     String
  content   String   @db.Text // Markdown supported
  excerpt   String?  // Auto-generated from first 200 chars

  // Organization
  tags         String[] // Can reuse existing tag system
  isPinned     Boolean  @default(false)

  // Enhanced Properties
  priority     String?  @default("medium") // low, medium, high, urgent
  status       String?  @default("active") // draft, active, archived
  reviewDate   DateTime? // For notes that need periodic review
  confidential Boolean  @default(false) // Flag for sensitive legal content

  // Smart Linking (parsed mentions stored as JSON)
  links        Json?    // {tasks: [], matters: [], projects: [], notes: []}

  // Optional Relations (link notes to tasks or matters)
  taskId    String?
  matterId  String?
  projectId String?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  task      Task?    @relation(fields: [taskId], references: [id], onDelete: SetNull)
  matter    Matter?  @relation(fields: [matterId], references: [id], onDelete: SetNull)
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@map("notes")
  @@index([isPinned])
  @@index([createdAt])
  @@index([taskId])
  @@index([matterId])
  @@index([projectId])
  @@index([priority])
  @@index([status])
  @@index([reviewDate])
  @@index([confidential])
}
